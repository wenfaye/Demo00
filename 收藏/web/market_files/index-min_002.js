KISSY.add("tbc/search-suggest/1.4.14/index",function(e,t,r,n,o,a,i,u,s){function l(e){for(var t="",r=0;r<e.length;++r){var n=e.charCodeAt(r).toString(16).toUpperCase();t+="\\u"+"0000".substr(n.length)+n}return t}var c=r.extend({initializer:function(){var e=this;e._initCombo(),e.bindUtil()},bindUtil:function(){var e=this;e.Utils=new u,e.Stat=new s(e.get("statConfig"))},_setComboCache:function(e){var t=this,r=t.get("tab");t.configArr=t.configArr||[],t.configArr[r]={data:e}},_checkHasTab:function(){var e=this,t=e.getPlugin("tab");t||(e.tabNode=e.get("form"))},_initComboEvent:function(){var e=this,t=e.comboBox,r=t.get("input");r.on("mousedown",function(n){if(e.fire("beforeFocus")!==!1){var o=KISSY.trim(r.val()),a=e.get("sugConfig"),i=!0;i&&(a.autoCollapsed||""===o)&&t.sendRequest(o)}n.stopPropagation()}),r.on("focus",function(){e.fire("beforeFocus")}),r.on("blur",function(){return e.fire("beforeBlur")===!1?!1:void 0});var o=e.get("sugConfig").itemClick,a=!0;if(o&&KISSY.isFunction(o)){a=!1;var i=o.apply(this,arguments);i!==!1&&(a=!0)}a&&t.on("click",e.comboClick,e),t.on("afterCollapsedChange",e._addExtraEvent,e),t.on("afterCollapsedChange",function(t){e.fire("afterCollapsedChange",t)}),t.on("beforeQueryChange",function(t){e.fire("beforeQueryChange",t)}),t.on("beforeSetInputValue",function(){var t=e.get("label");t&&n.hide(t)}),e._formSubmitEvent(),e.query=r.val();var u=e.get("label");u&&u.on("click",function(){t.sendRequest(r.val())})},_formSubmitEvent:function(){var e,t=this,r=t.comboBox,n=r.get("input"),o=n.parent("form"),a=r.get("input");o.on("submit",function(r){t.fire("beforeSubmit",{el:o,isInitSearch:!0})!==!1?(e=o.attr("action"),""===KISSY.trim(a.val())&&t._emptyJump(o)===!1&&r.preventDefault(),t.serializeToForm(o,e)):r.halt()})},serializeToForm:function(e,t){var r,n,o,a="",i="";if(t&&e){if(-1===t.indexOf("?"))return;if(a=t.split("?")[1]){r=a.split("&");for(var u in r)n=r[u].split("="),o=n[0],o&&!e[0][o]&&(i+='<input type="hidden" name="'+n[0]+'" value="'+n[1]+'"/>');e.append(i)}}},_defaultPageJump:function(e){var t,r=this,n=r.tabNode;if(!n)return!1;if(t=e.attr("data-defaultpage")||n.attr("data-defaultpage")){if(!/(http(s:|:))?\/\//.test(t))return!1;e.attr("action",t)}},_emptyJump:function(e){var t,r=this,n=e.one("label");return n?(t=n.one("span"),t&&""!==t.text()?(n.hide(),void r._holderJump(e,t.text())):r._defaultPageJump(e)):r._defaultPageJump(e)},_holderJump:function(e,t){var r=e[0].q;r&&(r.value=t),e.append('<input type="hidden" name="style" value="grid" />')},_sendSnapshot:function(e){var t,r=this,n=[],o=-1,a=0,i=r.get("statConfig");if(i.unicode)for(e.selected=l(e.selected),a=0;a<e.children.length;a++)t=e.children[a],t.value=l(t.value),e.selected==t.value?o=a:n.push(t.value+"/"+t.index);else for(a=0;a<e.children.length;a++)t=e.children[a],e.selected==t.value?o=a:n.push(t.value+"/"+t.index);var u="f_stats_show=xialalist:";u+=n.join(","),u=u+";query:"+e.query,u=u+";selected:"+e.selected+"/"+o,u=u+";time:"+KISSY.now(),u=u+";nick:"+r.getNick(),r.Stat.send(u,!0)},comboClick:function(e){var r,n=this,o=e.target.get?e.target.get("el"):t.one(e.currentTarget),a=n.comboBox,i=o.one(".item-text, .search-menu-key, .search-menu-history-key"),u=!1,s=n.get("form"),l=n.get("sugConfig").isSendByForm;if(i){r=i.text();var c=n.historyArr;if(c)for(var f=0,g=c.length-1;g>=f;f++)if(r===c[f]){u=!0;break}}for(var d=a.get("menu"),m=d.get("children"),p=[],h=0;h<m.length;h++){var v=m[h],b=v.get("value");b&&p.push({index:h,value:b[0]})}var C={query:n.query||"",children:p,selected:r||""};if(n._sendSnapshot(C),n.fire("beforeSubmit",{el:o,isInitSearch:!1,isNotSave:u})!==!1){var S=n.getRedirect(o);l?(n.serializeToForm(s,S),s[0].submit()):n.redirect(S)}},getRedirect:function(e){var t=this,r=t.query,o=t.query,a=n.children(e),i=n.attr(a,"data-key")||"q="+r,u=t.get("form")[0],s=n.attr(u,"action"),l=n.attr(a,"data-action")||t.get("action")||s,c=n.attr(a,"data-source-stat")||"source=suggest",f="&_input_charset=utf-8&wq="+encodeURIComponent(o)+"&suggest_query="+encodeURIComponent(r)+"&"+c,g=t._getInputsVal(u);return l+=l.indexOf("?")>-1?"&":"?",l+g+"&"+i+f},redirect:function(e){var t=this,r=t.get("sugConfig").isEncode;r?e=t.urlEncode(e):(e=e.replace(/(#)[^!]/g,function(e,t){return e.replace(t,"%23")}),e=e.replace(/#!/g,"#"));var n=document.createElement("a");n.setAttribute("href",e),n.setAttribute("target","_self"),n.style.display="none",document.body.appendChild(n),n.click()},urlEncode:function(e){var t=/[\u4e00-\u9fa5\uf900-\ufa2d+#\s]+/g.exec(e);if(t)try{e=e.replace("？","?"),e=e.replace(/[\u4e00-\u9fa5\uf900-\ufa2d+#]+/g,function(e){return encodeURIComponent(e)}),e=e.replace(/\s/g,function(){return"+"}),e+="&ie=utf-8"}catch(r){KISSY.log("url编码出错!")}return e},_getInputsVal:function(e){for(var t,r,o=this,a=o.get("sugConfig"),i=a.excludeParam,u=[],s=n.query("input",e),l=s.length-1;l>=0;l--)t=s[l],r=t.name,r&&!KISSY.inArray(r,i)&&u.push(r+"="+encodeURIComponent(t.value));return u.length<1?"":"&"+u.join("&")},_getDefComboCfg:function(){return{focused:!1,hasTrigger:!1,matchElWidth:!0,srcNode:".allWidth",highlightMatchItem:!1,menu:{align:{overflow:{adjustY:0}}},cache:!0}},_prepareHtml:function(e){var r=this,o=n.get(e.node),a=o.innerHTML,i=e.prefixCls,u=n.get(e.placeholderEl),s=u?u.outerHTML:"",l='<div class="{cls}combobox"><div class="{cls}combobox-input-wrap"></div></div>',c=l.replace(/{cls}/g,i).replace(/{label}/g,s).replace(/{input}/g,a),f=n.create(c),g={"aria-haspopup":"true","aria-combobox":"list",role:"combobox",autocomplete:"off","class":i+"combobox-input","x-webkit-grammar":"builtin:translate"};return n.attr(o,"aria-label")||(g["aria-label"]=r._isOpen("history")?"请输入搜索文字或从搜索历史中选择":"请输入搜索文字"),n.attr(o,g),n.wrap(o,f),this.get("sugConfig").focused&&n.get(o).focus(),t.one("."+i+"combobox")},_isOpen:function(e){var t=this,r=t.get("mods"),n=r.sort;return KISSY.inArray(e,n)},_getRenderMods:function(){var e=this,t=KISSY.merge(a,e.get("mods"));e.set("mods",t)},_getDataSourceCfg:function(){var e=this,t=e.get("sugConfig"),r=e.get("dataSourceCfg"),n=t.sourceUrl;return location.href.indexOf("debug=test")>-1&&(n=n.replace("suggest.taobao.com/sug?","suggest.proxy.taobao.org/sug?")),-1===n.indexOf("bucketid")&&(n+="&bucketid="+e._getBucketId()),r.xhrCfg.url=n,r.parse=KISSY.bind(e.parse,e),r},_getBucketId:function(){return(new i).getBucket()},_getComboCfg:function(e){var r=this,n=r.get("sugConfig"),o=r._getDefComboCfg(),a=n.prefixCls,i=t.one("."+a+"-combobox");return i||(i=r._prepareHtml(n)),o.srcNode=i,o.dataSource=e,o.format=KISSY.bind(r.format,r),o.prefixCls=n.prefixCls,o.holderEl=t.one(n.placeholderEl),o.maxItemCount=o.maxItemCount||e.maxItemCount,o},_initCombo:function(){var e,t,r=this,n=r._getDataSourceCfg(),a=r.get("sugConfig");r._getRenderMods(),a.sourceUrl?(e=new o.RemoteDataSource(n),e.maxItemCount=10):(e=new o.LocalDataSource(n),e.maxItemCount=0),r._setComboCache(e),t=r._getComboCfg(e);var i=new o(t);i.render(),r.comboBox=i,r._checkHasTab(),r._initComboEvent()},update:function(e){for(var t=this,r=t.get("plugins"),n=0,o=r.length-1;o>=n;n++){var a=r[n];a&&KISSY.isFunction(a.update)&&a.update.call(a,e)}},parse:function(e,t){var r,n=this,o=n.fire("beforeParse",{results:t,query:e});if(o===!1)return[[""]];if(o&&(t=o),!t||!t.result)return KISSY.log("接口无数据!"),[[""]];r=t.result,delete t.result;var a=n.comboBox.get("dataSource");if((a.extraData||(a.extraData=[]))[e]=t,0===r.length)return[[""]];for(var i in r)r[i]||r.splice(i,1);return r},format:function(e,t){var r=this;return r.resultArr=[],r.render(e,t),r.resultArr},render:function(e,t){var r,n,o,a,i,u,s=this,l=s.get("mods"),c=l.sort,f=s._adjustExtra(e,l.showExtra);s.query=e;for(var g=0,d=c.length-1;d>=g;g++)if(u=c[g])if("list"!==u){if(i=s.getPlugin(u),i&&i.renderPlugin)i.renderPlugin({query:e,results:t});else if(n=l[u],n&&f&&(!(a=n.pos)||o!==a)){if(r=n.tmpl,!r)continue;var m=s.resultArr.length,p=s.diffLen||0;o=s.defaultRender({tmpl:r,name:u,pos:a,always:n.always&&t.length>0,callback:n.callback,index:m-p})}}else n=l[u],r=n.tmpl,s._list(e,t,r);s.fire("afterQueryChange",{query:e})},defaultRender:function(e){var t,r=this,n=e.tmpl,o=e.name,a=r.comboBox.get("dataSource"),i=r.query,u=r.get("sugConfig").prefixCls,s=a.extraData,l=e.pos,c=e.index;if(s&&s[i]||e.always){var f,g,d=r._getDate(),m={$query:i,$queryUrl:encodeURIComponent(i),$date:d,prefixCls:u};if(!e.always){if(f=s[i][o],g=!0,!f)return;if(KISSY.isArray(f)){f.length>2&&(f.length=2);for(var p=0,h=f.length;h>p;p++){var v=f[p];if(KISSY.isArray(v)){g=!1;for(var b=0,C=v.length;C>b;b++)m["$"+b]=v[b]||"";m.$3=encodeURIComponent(m.$2),m.$index=c+1+p,t=KISSY.substitute(n,m),r.addContent({html:t,query:i,position:l,callback:e.callback})}else m["$"+p]=v,m.$index=c+1+p}return g&&(t=KISSY.substitute(n,m),r.addContent({html:t,query:i,position:l,callback:e.callback})),l}if(KISSY.isObject(f)){for(var S in f)m[o+"_"+S]=f[S];"active"===o&&(m.$query=f.query+" "+f.tag)}else m[o]=f,m.$query=f}return m.$index=c+1,t=KISSY.substitute(n,m),r.addContent({html:t,query:m.$query||i,position:l,callback:e.callback}),l}},_adjustExtra:function(e){return""!==e?!0:!1},getNick:function(){var e=this;return e._getCookie("lgc")||e._getCookie("tracknick")},_getCookie:function(e){var t=window;if(t.userCookie&&!KISSY.isUndefined(t.userCookie[e]))return t.userCookie[e];if(t.SRP_COOKIES||(t.SRP_COOKIES={})&&KISSY.isUndefined(SRP_COOKIES[e])){var r=document.cookie.match("(?:^|;)\\s*"+e+"=([^;]*)");SRP_COOKIES[e]=r&&r[1]?decodeURIComponent(r[1]):""}return SRP_COOKIES[e]},_getDate:function(){var e=new Date;return e.getFullYear()+"-"+(e.getMonth()+1)+"-"+(e.getDate()+1)},_list:function(e,t,r){var n,o=this,a=o.get("sugConfig").resultFormat,i=o.resultArr||(o.resultArr=[]);KISSY.each(t,function(o,u){if(!o||!o[0])return void t.splice(u,1);var s,l=o[0],c="",f=e;if(l.match(/<b>/))n=l.replace(/<b>(\S+?)<\/b>/g,function(e,t){return t}),c=l,l="";else{for(;l.indexOf(f)<0;)f=f.substr(0,f.length-1);""===f?(c=l,l=""):0===l.indexOf(f)?(c=f,l=l.replace(f,"")):(c=l,l=""),n=o[0]}for(var g in i)if(s=i[g],s.textContent===o[0]&&s.unique)return;r=r.replace("{format}",a),i.push({textContent:n,content:KISSY.substitute(r,{query:c,text:l,index:u+1,count:o[1],textContent:encodeURIComponent(n)}),list:!0})}),o.resultArr=i},addContent:function(e){var t=this,r=e.html,n=e.position,o=e.query;if(!n){var a=t.resultArr||[];return void a.push({content:r,textContent:o})}t["__"+n]={tmpl:r},t._addExtraEvent()},_renderHeader:function(e,r,n){var o=r&&r.type+"-header"||"";if(r){var a=this.get("sugConfig").prefixCls;e||(e=new t("<div class='"+a+"combobox-menu-header "+o+"'></div>").prependTo(n)),e.empty().append(r.tmpl)}else e&&e.remove()},_renderFooter:function(e,r,n){var o=this,a=o.get("sugConfig").prefixCls,i=r&&r.type+"-footer"||"";if(r){e||(e=new t("<div class='"+a+"combobox-menu-footer "+i+"'></div>").appendTo(n)),r.css&&e.css(r.css),e.empty().append(r.tmpl);var u=e.one("."+a+"menu-history-clean");u&&u.on("click",function(e){e.halt();var t=o.getPlugin("history");t._cleanHistory()})}else e&&e.remove()},_addExtraEvent:function(e){var t=this,r=t.comboBox||t,n=t.__header,o=t.__footer,a=t.__lastHeader,i=t.__lastFooter,u=t.get("sugConfig").prefixCls;if(!e||e&&!e.newVal){var s=r.get("menu");if(!s.get)return;var l=s.get("el");if(!l||l.all("."+u+"menuitem").length<1)return;var c=l.one("."+u+"combobox-menu-header"),f=l.one("."+u+"combobox-menu-footer");a!==n&&(t.__lastHeader=n,t._renderHeader(c,n,l)),i!==o&&(t.__lastFooter=o,t._renderFooter(f,o,l))}else t.__header=null,t.__footer=null}},{ATTRS:{sugConfig:{value:{extraPassParams:"",extraPostParams:"",sourceUrl:"",tab:"item",autoCollapsed:!0,focused:!1,prefixCls:"search-",excludeParam:["q"],resultFormat:"约{count}个宝贝"},setter:function(e){var t=this.get("sugConfig");return KISSY.mix(t,e,void 0,void 0,!0)}},mods:{value:{},setter:function(e){return e}},input:{getter:function(e){return e||(e=this.comboBox.get("input"))}},form:{getter:function(e){return e||(e=this.get("input").parent("form"))}},label:{getter:function(e){return e||(e=this.comboBox.get("holderEl"))}},menu:{getter:function(e){return e||(e=this.comboBox.get("menu"))}},dataSourceCfg:{value:{xhrCfg:{url:"",dataType:"jsonp",scriptCharset:"utf-8",data:{code:"utf-8"}},allowEmpty:!0,paramName:"q",cache:!0}},statConfig:{value:{tongjiKey:{logkey:"/tongji",chksum:"H51884970"},pvKey:{logkey:"/search",chksum:"H51884969"},unicode:!1},setter:function(e){var t=this.get("statConfig");return KISSY.mix(t,e,void 0,void 0,!0)}}}});return c},{requires:["node","base","dom","./suggest","./mods/mods","./mods/bts","./mods/utils","./mods/stat"]});