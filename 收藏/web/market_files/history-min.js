KISSY.add("tbc/search-suggest/1.4.14/plugin/history",function(e,t,r,i,n){function a(e){a.superclass.constructor.call(this,e||{}),KISSY.sug=KISSY.bind(this._retSug,this)}var o;return KISSY.extend(a,t,{pluginInitializer:function(e){var t=this,r=e.get("sugConfig"),i=r.tab||"";o=e.Stat,e.set("extend",{history:!0}),t.set("caller",e),t.localQueryMap={},t.localQueryPinyingMap={},t.historyLocalQuery=t.localQueryMap[i]=new n({name:"history",tab:i,user:e.getNick()}),t.pinyingLocalQuery=t.localQueryPinyingMap[i]=new n({name:"pinyin",tab:i,user:e.getNick()}),t.hitedHistoryListMap={};var a=e.comboBox;setTimeout(function(){t.historyLocalQuery.checkFlash({onSuccess:function(){t.historyReady=!0,a.on("afterCollapsedChange",function(e){if(!e.newVal){a.detach("afterCollapsedChange",arguments.callee);var i=a.get("menu").get("el");i.delegate("mousedown","."+r.prefixCls+"menu-history-delete",t._historyDeleteMousedown,t)}}),e.on("beforeSubmit",function(e){var r=a.get("input").val(),i=e.isNotSave;""===KISSY.trim(r)||r.match(/[<>'"]/g)||t.pinyingLocalQuery&&!i&&t.pinyingLocalQuery.save(r,KISSY.trim(r))}),setTimeout(function(){t._getPinyinQuery()},1e3)},onFailure:function(){KISSY.log("loading flashStorage failure!")}})},500)},_dealUrl:function(e,t){var r="&area=history",i=e.indexOf(r)>-1;return t?!i&&e+r:i&&e.replace(r,"")},_getPinyinQuery:function(){var e=this,t=e.historyLocalQuery,r=e.pinyingLocalQuery.query();if(r.length>0){var i=decodeURIComponent(r[0].key);/[\u4e00-\u9fa5]/.test(i)?(e._getPinyin(r[0].key),e.pinyingLocalQuery.clearByDay(0)):(e.pinyingLocalQuery.clearByDay(0),t.save(i,KISSY.trim(i)))}},_renderHTML:function(e,t){var r,i=this,n=i.get("caller"),a="",o=n.get("mods").history.tmpl,t=t||{},s=n.resultArr||(n.resultArr=[]),l=[];e=KISSY.unique(e);for(var u=0,c=e.length-1;c>=u;u++)0!==u&&(t.attr=""),t.index=(u+1).toString(),t.historyItemValue=decodeURIComponent(e[u].key),t.historyItemQuery=e[u].key,a=KISSY.substitute(o,t),r=t.historyItemValue,l.push(r),s.push({content:a,textContent:r,unique:!0});n.historyArr=l},renderPlugin:function(){if(this.historyReady){var e,t,r=this,i=r.get("caller"),n=i.query,a=r.historyLocalQuery.query(n),o=r.get("limit"),s=i.get("sugConfig"),l=i.comboBox.get("dataSource"),u=l.extraData&&l.extraData[n];if(r.get("web")&&""===n&&u&&u.cloud)return void r._renderHTML(u.cloud,{prefixCls:s.prefixCls});""===n&&a.length>0?(i.__header={tmpl:'<div class="history-box"><span>最近搜过</span></div>',type:"history"},i.__footer=null,e=o):(i.__header=null,i.__footer=null,e=2),t=a.splice(0,e),i._addExtraEvent(),r._renderHistoryItems(t),r.hitedHistoryListMap[n]=t}},_historyDeleteMousedown:function(e){for(var t=this,i=t.get("caller"),n=r.one(e.target),a=n.parent().attr("data-value"),o=n.parent(2),s=i.comboBox,l=s.get("menu"),u=l.get("children"),c=n.attr("data-type"),y=0;y<u.length;y++){var g=u[y];if(g.get("el")[0]===o[0]){l.removeChild(g,!0);break}}var d=t.historyLocalQuery;d&&("history"===c?d.deleteItem(a):"most"===c&&(d._setKey({name:"most"}),d.save(a,a),d._setKey({name:"history"}))),s.sendRequest(i.query),t._sendStat(a)},_sendStat:function(e){var t,r=this.get("caller"),i={},n=location.hostname,a="op=del&nk={nick}&src={host}&q={query}&app=sug";i.nick=r.getNick(),i.query=e,i.host=n.replace(/com|\./g,""),t=KISSY.substitute(a,i),o&&o.send(t)},_renderHistoryItems:function(e,t){var r=this,i={},n=r.get("caller"),a=n.get("sugConfig");i.prefixCls=a.prefixCls,i.attr=t&&t.attr||"",i.extraParam=t&&t.param||"history",r._renderHTML(e,i)},_getPinyin:function(e){var t=this,r=location.protocol+"//suggest.taobao.com/sug?code=utf-8&area=py&callback=KISSY.sug&q="+e;t._savedInputValue=decodeURIComponent(e),KISSY.getScript(r)},_retSug:function(e){if(e&&e.result){var t=e.result[0],r=this,i=r._savedInputValue;r.historyLocalQuery&&r.historyLocalQuery.save(i,KISSY.trim(t))}},_cleanHistory:function(){var e=this,t=e.get("caller"),r=t.comboBox,i=r.get("menu"),n=i.get("el"),a=r.get("input"),o=t.get("sugConfig"),s=o.prefixCls,l=n.one("."+s+"combobox-menu-header");e.historyLocalQuery.clearByDay(0),e.hitedHistoryListMap={};var u=l.siblings();u.css("display","none"),l.html('<div class="history-box"><span>搜索历史已清空</span></div>');var c=new KISSY.Anim(n,{opacity:0},3,"easeIn",function(){u.css("display","block"),n.css({opacity:1,visibility:"hidden"})});c.run(),a.on("blur keydown mousedown",function(e){c.isRunning()&&c.stop(!0),t.__header=null,t.__footer=null,"keydown"===e.type&&this.value&&n.css("visibility","visible"),a.detach("blur keydown mousedown",arguments.callee)})},update:function(e){var t=this,r=encodeURI(e.tab);t.localQueryMap[r]||(t.localQueryMap[r]=new n({name:"history",tab:r,user:t.get("caller").getNick()}),t.localQueryPinyingMap[r]=new n({name:"pinyin",tab:r,user:t.get("caller").getNick()})),t.pinyingLocalQuery=t.localQueryPinyingMap[r],t.historyLocalQuery=t.localQueryMap[r],t._getPinyinQuery()}},{ATTRS:{pluginId:{value:"history"},limit:{value:10,setter:function(e){return KISSY.isNumber(e)?e:void 0}}}}),a},{requires:["base","node","event","../mods/local-query"]});