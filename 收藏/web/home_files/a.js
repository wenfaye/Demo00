KISSY.add("tbc/add-to-cart/1.2.5/plugin/mods/config",function(a,b,c,d){var e=(a.getLogger("config"),{});d.exports={set:function(b,c){return a.isObject(b)||!b?e=b||{}:void(e[b]=c)},get:function(b){b=b||"";var c=b.split("."),d="";return a.each(c,function(a,b){return d=0===b?e[a]:d[a],"undefined"==typeof d?!1:void 0}),d}}}),KISSY.add("tbc/add-to-cart/1.2.5/plugin/mods/utils",["dom","cookie"],function(a,b,c,d){var e=(a.getLogger("utils"),b("dom")),f=-1===location.host.indexOf("daily."),g=f?"taobao.com":"daily.taobao.net";d.exports={isOnline:!f,tbDomain:g,cartUrlPre:"//cart."+g+"/",getToken:function(){return e.val("#_tb_token_")||e.val("#J_TokenField")||""},getTrackId:function(){return b("cookie").get("t")},parseItemUrl:function(b){if(b&&a.isString(b)&&(-1!==b.indexOf("item.")||-1!==b.indexOf("detail."))){var c;if(b.indexOf("id=")>-1?c=b.split("id=")[1]:b.indexOf("item_id=")>-1&&(c=b.split("item_id=")[1]),c){var d=c.split("&")[0];if(d)return{itemId:d,isChaoshi:b.indexOf("chaoshi.")>-1}}}},toYuan:function(a){return parseFloat(parseInt(a,10)/100).toFixed(2)},removePicSuffix:function(a){return a.replace(/_(sum|\d{2,5}x\d{2,5})\.jpg$/,"")}}}),KISSY.add("tbc/add-to-cart/1.2.5/plugin/mods/sku/prop/index.tpl",function(a,b,c,d){function e(a,b,c){return a&&b[0]===a[c.replace(/&nbsp;/g,"").replace(/\s+/gi,"").replace(/\u3000/g,"")]}a.getLogger("sku.tpl");d.exports={generate:function(b){var c="";return a.each(b.prop,function(d,f){c+='<dl class="tbc-sku-line tbc-sku-prop clearfix J_Prop"><dt>'+f+'</dt><dd><ul class="clearfix">',a.each(d,function(a,d){"pvId"!==d&&"type"!==d&&(c+='<li data-prop="'+f+'" data-pvid="'+d+'" class="prop-block J_PropBlock ',e(b.curSku,a,f)&&(c+="selected"),2===a.length&&(c+=" img-mode "),c+='" title="'+a[0]+'"><a href="javascript: void(0)" ',2===a.length&&(c+=' style="background:url('+a[1]+') 50% 50% no-repeat;" '),c+="><span>"+a[0]+"</span></a><i></i></li>")}),c+="</ul></dd></dl>"}),c}}}),KISSY.add("tbc/add-to-cart/1.2.5/plugin/mods/sku/prop/index",["node","tbc/sku/1.0.7/index","./index.tpl.js"],function(a,b){function c(a,b,c){this.$container=a,this.data=b,this.skuInfo={prop:{},pvids:null},this.ec=c,this.render(b)}var d=(a.getLogger("prop"),b("node").all),e=b("tbc/sku/1.0.7/index"),f=b("./index.tpl.js");return c.prototype.render=function(a){var b=this,c=this.$container.append(d(f.generate(a))),g=new e({root:c,hook:".J_PropBlock",skuMap:a.skuMap,attrName:"data-pvid",selectedClass:"selected",disabledClass:"disabled"});g.on("skuFound skuChanged",function(a){var c=a.sku;b.ec.fire("skuChange",c),b.selectedSku=c}),g.on("selectionChanged",function(a){b.ec.fire("skuSelectionChanged",a.sku)}),g.on("skuLost",function(){b.selectedSku=null}),g.init()},c.prototype.check=function(){var a=this;return a.selectedSku?a.selectedSku:{error:"\u8bf7\u9009\u62e9\u5546\u54c1\u5c5e\u6027"}},c}),KISSY.add("tbc/add-to-cart/1.2.5/plugin/mods/sku/amount/index.tpl",function(a,b,c,d){a.getLogger("amount.tpl");d.exports={generate:function(a){return'<dl class="tbc-sku-line tbc-sku-amount clearfix"><dt>\u6570\u91cf</dt><dd class="clearfix"><div class="amount-wp"><a href="#" class="J_AmountOp J_Minus tbc-amount-minus no-minus"><span class="tbc-cart-iconfont">&#xe601;</span><span class="origin">-</span></a><input type="text" value="'+(a.quantity||1)+'" class="J_AmountInput amount-input" /><a href="#" class="J_AmountOp plus J_Plus  tbc-amount-plus"><span class="tbc-cart-iconfont">&#xe600;</span><span class="origin">+</span></a></div><span class="unit">\u4ef6</span><span class="stock">\uff08\u5e93\u5b58<em class="J_Stock" data-defstock="'+a.item.stock+'">'+a.item.stock+"</em>\u4ef6\uff09</span></dd></dl>"}}}),KISSY.add("tbc/add-to-cart/1.2.5/plugin/mods/sku/amount/index",["node","./index.tpl.js"],function(a,b,c,d){function e(a,b,c){this.ec=c,this.data=b,this.$container=a,this.render(b),this.ec.on("skuChange",function(a){this._updateStock(a),this._validateQuantity(a)},this)}var f=(a.getLogger("amount"),b("node").all),g=b("./index.tpl.js");e.prototype.getCurVal=function(){return parseInt(this.$input.val(),10)},e.prototype.render=function(a){this.$container.append(f(g.generate(a))),this.$stock=f(".J_Stock",this.$container),this.$input=f(".J_AmountInput",this.$container),this.$minusBtn=f(".J_Minus",this.$container),this.$plusBtn=f(".J_Plus",this.$container),this.$container.delegate("click",".J_Plus",function(a){a.preventDefault();var b=this.getCurVal();this.$plusBtn.hasClass("no-plus")||(this.$input.val(b+1),b>0&&this.$minusBtn.replaceClass("no-minus","minus"),this._validateQuantity())},this),this.$container.delegate("click",".J_Minus",function(a){if(a.preventDefault(),this.$minusBtn.hasClass("no-minus"))return!1;var b=this.getCurVal();return b>1&&this.$input.val(--b),2>b&&this.$minusBtn.replaceClass("minus","no-minus"),this._validateQuantity(),!0},this)},e.prototype._getCurrentStock=function(){return parseInt(this.$stock.text(),10)},e.prototype._updateStock=function(a){this.$stock.html(a.stock)},e.prototype.check=function(){var a=this,b=/^\d+$/,c=a.$input,d=a.getCurVal();if(!b.test(c.val()))return c.val(d||1),{error:"\u8bf7\u586b\u5199\u6b63\u786e\u7684\u5b9d\u8d1d\u6570\u91cf\uff01"};var e=a._getCurrentStock();if(!e)return{error:"\u6682\u65f6\u7f3a\u8d27"};if(d>e)return{error:"\u6700\u591a\u53ef\u8d2d\u4e70"+e+"\u4ef6\u5546\u54c1"};if(a.checkQuantity){var f=a.checkQuantity(d);if(f)return{error:f}}return{quantity:d}},e.prototype._validateQuantity=function(){var a=this.check();return a.error?this._showErrorInfo(a.error):!0},e.prototype._showErrorInfo=function(){},d.exports=e}),KISSY.add("tbc/add-to-cart/1.2.5/plugin/mods/sku/pic/index.tpl",function(a,b,c,d){a.getLogger("index.tpl");d.exports={generate:function(a){return'<dl class="tbc-sku-line tbc-sku-pic"><dt>\u5b9d\u8d1d\u56fe\u7247</dt><dd><div class="tb-pic item-pic"><div class="wrapper"><img src="'+a.item.picUrl+'_160x160.jpg" class="J_ItemPic" /></div></div></dd></dl>'}}}),KISSY.add("tbc/add-to-cart/1.2.5/plugin/mods/sku/pic/index",["node","./index.tpl.js","../../utils"],function(a,b,c,d){function e(a,b,c){this.$container=a,this.data=b,this.render(b),this.defaultImage=this.data.item.picUrl,c.on("skuSelectionChanged",function(a){this.update(a)},this)}var f=(a.getLogger("pic"),b("node").all),g=b("./index.tpl.js"),h=b("../../utils");e.prototype.render=function(a){this.$container.append(f(g.generate(a))),this.$img=f("img.J_ItemPic",this.$container)},e.prototype.update=function(b){var c=this,d="";if(b.props){var e=c.data.prop;a.each(b.props,function(a){if(a){var b=f(a),c=b.attr("data-prop"),g=b.attr("data-pvid");if(e[c]&&e[c][g]&&2===e[c][g].length)return d=e[c][g][1],!1}})}d=d||this.defaultImage,this.$img.attr("src",h.removePicSuffix(d)+"_160x160.jpg")},d.exports=e}),KISSY.add("tbc/add-to-cart/1.2.5/plugin/mods/sku/sku",["node","io","../utils","event","./prop/index","./amount/index","./pic/index"],function(a,b,c,d){function e(b){var c=this;a.mix(c,b),c.data={},c.hasSku=!1,c.mods={},c.ec=a.mix({},i.Target),a.isString(c.$container)&&(c.$container=f(c.$container)),c.autoload!==!1&&c.get(function(){c.render(),c._rendered&&c._rendered()})}SALE_NOT_FOUND="\u8be5\u5b9d\u8d1d\u5df2\u88ab\u4e0b\u67b6\u6216\u5220\u9664";var f=(a.getLogger("sku"),b("node").all),g=b("io"),h=b("../utils"),i=b("event");e.prototype.get=function(b){var c=this;return g({url:"//tbskip."+h.tbDomain+"/json/item_sku.do",dataType:"jsonp",data:{item_num_id:c.itemId},jsonpCallback:"jsonpGetSkuInfo"+a.guid(),success:function(d){a.isPlainObject(d)&&d.success?(c.data=d,c.hasSku=!!d.prop,b&&b(null,d)):b&&b(new Error("\u83b7\u53d6\u5546\u54c1\u5c5e\u6027\u4fe1\u606f\u5931\u8d25\uff0c\u8be5\u5546\u54c1\u53ef\u80fd\u5df2\u7ecf\u4e0b\u67b6\u6216\u5220\u9664"))},error:function(){b&&b(new Error("\u83b7\u53d6\u5546\u54c1\u5c5e\u6027\u4fe1\u606f\u5931\u8d25"))},timeout:10,charset:"gbk"})},e.prototype.render=function(c){c=c||this.data;var d={Sku:b("./prop/index"),Amount:b("./amount/index"),Pic:b("./pic/index")};if(a.each(d,function(a,b){this["has"+b]!==!1&&(this.mods[b.toLowerCase()]=new a(this.$container,this.data,this.ec))},this),!a.isEmptyObject(this.mods)){var e=f(this.btnTpl||'<dl class="tbc-sku-line tbc-sku-operate"><dt>\u64cd\u4f5c</dt><dd><a href="javascript:void(0);" class="add-cart J_AddCart"><span>\u786e\u5b9a</span></a><a href="javascript:void(0);" class="cancel J_Cancel"><span>\u53d6\u6d88</span></a></dd></dl>');this.$container.append(e).delegate("click",".J_Cancel",function(a){a.preventDefault(),this._cancel&&this._cancel()},this).delegate("click",".J_AddCart",function(a){a.preventDefault(),this._confirm&&this._confirm(this.check())},this)}},e.prototype.check=function(){var b={error:null};return a.each(this.mods,function(c){if(c&&c.check){var d=c.check();if(d.error)return b=d,!1;b=a.mix(b,d)}}),b},d.exports=e}),KISSY.add("tbc/add-to-cart/1.2.5/plugin/mods/event-center",function(a,b){var c=a.mix({},b.Target),d={};return{broadcast:function(b,e){return a.log("[global]:broadcast event:"+b),d[b]=e,c.fire(b,e)},listen:function(b,e){c.on(b,e),d[b]&&e.call(this,a.mix(d[b],{target:this,type:b}))},detach:function(a,b){c.detach(a,b)}}},{requires:["event"]}),KISSY.add("tbc/add-to-cart/1.2.5/plugin/mods/add",["./utils","./event-center"],function(a,b,c,d){function e(){window.TB?window.TB&&!window.TB.AddCart&&(window.TB.AddCart={}):window.TB={AddCart:{}}}var f=a.getLogger("add"),g=b("./utils"),h=b("./event-center"),i=g.cartUrlPre+"add_cart_tiny.htm",j=g.cartUrlPre+"top_cart_quantity.htm",k=!1;d.exports={add:function(b,c){f.info("add to cart"),e();var d=g.getTrackId();if(!d){if(k)return c&&c(new Error("\u8ba4\u8bc1\u5931\u8d25\uff0c\u8bf7\u767b\u9646\u540e\u91cd\u8bd5"),{data:b});var l=arguments.callee,m=this;return f.info("no trackId, load miniCart api for it."),a.getScript(j+"?callback=&appid=5&t="+a.now(),{success:function(){l.call(m,b,c)}}),void(k=!0)}f.info("trackId is: %s",d);var n={item_id:b.itemId,sku_id:b.skuId||null,quantity:parseInt(a.trim(b.quantity),10),t:a.now(),ct:d,source:b.source||"",_tb_token_:g.getToken()};h.broadcast("beforeAddToCart",n);var o=i+"?"+a.param(n);f.info("call api to add to cart: %s",o),a.getScript(o,a.bind(function(){var d=this,e=a.clone(TB.AddCart.CartResult);if(f.info("add to cart callback data: ",e),TB.AddCart.CartResult=null,e){if(e.error){if("\u65e0\u6cd5\u6dfb\u52a0\u8d2d\u7269\u8f66,\u8bf7\u767b\u5f55\u540e\u91cd\u8bd5!"===e.error)return a.use("tbc/mini-login/1.5.6/",function(a,e){e.on("close",function(){h.broadcast("addToCartError","\u65e0\u6cd5\u6dfb\u52a0\u8d2d\u7269\u8f66\uff0c\u8bf7\u767b\u5f55\u540e\u91cd\u8bd5"),c&&c(new Error("not login"),{data:b})}),e.show(function(){d.add(b)})}),!1;h.broadcast("addToCartError",{error:e.error,data:b})}else h.broadcast("addToCartSuccess",e);return c&&c(e.error?new Error(e.error):null,{result:e,data:b})}},this))}}}),KISSY.add("tbc/add-to-cart/1.2.5/plugin/mods/tip",["node","overlay"],function(a,b,c,d){function e(a,b){var c="error"===b?"&#xe603;":"&#xe604;";return'<div class="tbc-cart-tip-content"><span class="tbc-cart-icon-'+b+'">'+c+"</span>"+a+"</div>"}var f,g=(a.getLogger("tip"),b("node").all,b("overlay")),h=null;d.exports={show:function(a,b){return a?(b=b||"success",a=e(a,b),f&&clearTimeout(f),h?(h.hide(),h.set("content",a)):h=new g({elCls:"tbc-cart-tips tbc-cart-tips-"+b,align:{points:["cc","cc"]},content:a}),h.show(),h.center(),f=setTimeout(function(){h.hide()},3e3),!0):!1},hide:function(){f&&clearTimeout(f),h&&h.hide()}}}),KISSY.add("tbc/add-to-cart/1.2.5/plugin/mods/selector",["node","dom","overlay","event","./sku/sku","./add","./tip"],function(a,b,c,d){function e(b){var c=this;a.mix(c,b),l.hide(),c._initLoadingPopup(),c.$container=f('<div class="J_SelectorPopup tbc-add2cart-select-popup"></div>'),new j({itemId:c.itemId,$container:c.$container,_rendered:function(){c._removeLoadingPopup();var b=a.trim(g.html(c.$container));""===b?k.add({itemId:c.itemId,quantity:1}):(c._initPopup(),c._bindEvents())},_cancel:function(){l.hide(),c.popup&&c.popup.destroy()},_confirm:function(b){b.error?l.show(b.error,"error"):k.add({itemId:c.itemId,quantity:b.quantity,skuId:b.skuId||null},function(b){b?l.show(a.isString(b)?b:b.message,"error"):(l.show("\u6dfb\u52a0\u6210\u529f\uff01"),c.popup&&c.popup.hide())})}})}var f=(a.getLogger("selector"),b("node").all),g=b("dom"),h=b("overlay"),i=b("event"),j=b("./sku/sku"),k=b("./add"),l=b("./tip");a.augment(e,{_initLoadingPopup:function(){this.loadingPopup=new h({containerCls:"g-cart-loading",elCls:"g-cart-loading",width:20,height:20,align:{node:this.triggerEl,points:["tl","tl"]}})},_removeLoadingPopup:function(){if(this.loadingPopup){var b=this.loadingPopup.container;a.isFunction(this.loadingPopup.get)&&(b=this.loadingPopup.get("el")),f(b).remove(),this.loadPopup=null}},_initPopup:function(){this.alignProp={points:["cc","cc"]},g.remove(".g-cart");var a=new h({containerCls:"g-cart",elCls:"g-cart",align:this.alignProp,closable:!0,closeAction:"destroy"});a.render(),f(a.get("contentEl")).html("").append(this.$container),f(".ks-overlay-close-x",f(a.get("el"))).html("&#xe602;"),a.show(),a.center(),this.popup=a},_bindEvents:function(){this.popup&&i.on(window,"resize",function(){this.popup.set("align",this.alignProp)},this)}}),d.exports=e}),KISSY.add("tbc/add-to-cart/1.2.5/plugin/add2cart",["dom","event","./mods/config","./mods/utils","./mods/selector"],function(a,b,c,d){function e(b,c){a.makeArray(arguments);if(b=b||j.get("body"),b=a.isString(b)?j.query(b):b,b.length)return void a.each(b,function(a){a=j.get(a),e(a,c)});switch(b=b.getDOMNode?b.getDOMNode():b,j.nodeName(b)){case"img":break;default:f(b,c)}}function f(a,b){var c={config:b};switch(parseInt(b.loadType,10)){case 2:k.on(a,"mousemove",function(a){var b=a.target;if(b&&"IMG"==b.nodeName&&!j.data(b,n))return j.hasClass(b,p)||j.hasClass(b,q)?void this._maskAsTriggered(b):void(c.config&&c.config.preventAll&&!j.hasClass(b,r)||this._initTrigger(b,a.config))});break;default:k.on(a,"click",function(a){var b=a.target;b&&!j.data(b,o)&&(j.hasClass(b,q)||j.hasClass(b.parentNode,q))&&(a.preventDefault(),g(b))})}}function g(a){if(i.info("[init] initSelector for node: ",a),a){var c="A"===a.nodeName?a:a.parentNode;if(c){var d=c.href,e=m.parseItemUrl(d);if(!e||!e.itemId)return void h(a,o);i.info("[init] new Selector, itemId: %s",e.itemId);var f=b("./mods/selector");new f({itemId:e.itemId,isChaoshi:e.isChaoshi,triggerEl:a,trackPointUrl:"//gm.mmstat.com/tbcart.2.2"})}}}function h(a,b){i.info("[init] mark node as triggered",a,b),j.data(a,b||n,"1")}var i=a.getLogger("init"),j=b("dom"),k=b("event"),l=b("./mods/config"),m=b("./mods/utils"),n="cart-plugin-triggered",o="cart-plugin-click-triggered",p="J_CartPluginIgnore",q="J_CartPluginTrigger",r="J_CartPluginImg",s={};s._initTrigger=function(a,b){if(util.log("[init] initTrigger for node: ",a),a){var c=j.parent(a,"a");if(!c||!c.href||j.hasClass(c,q))return void h(a);var d=c.href,e=this._validItemUrl(d);if(!e||!e.itemId)return void h(a);h(a),util.log("[init] new Trigger, itemId: %s, redirectUrl: %s",e.itemId,d),new Trigger({itemId:e.itemId,triggerEl:a,redirectUrl:d,config:b,trackPointUrl:"//gm.mmstat.com/tbcart.2.1"})}},s._validItemUrl=function(b){if(b&&a.isString(b)&&(-1!==b.indexOf("item.")||-1!==b.indexOf("detail."))){var c;if(b.indexOf("id=")>-1?c=b.split("id=")[1]:b.indexOf("item_id=")>-1&&(c=b.split("item_id=")[1]),c){var d=c.split("&")[0];if(d)return{itemId:d,isChaoshi:b.indexOf("chaoshi.")>-1}}}},d.exports=function(a,b){b=l.set(b),e(a,b)}});