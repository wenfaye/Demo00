KISSY.add("my/mods/recommend",function(e,t,i){function a(){return window._ju_config.domain&&-1!==window._ju_config.domain.indexOf("daily")}function n(){var t=e.get(".J_PointRecommend");return t&&"true"==t.getAttribute("data-showshop")&&t.getAttribute("data-sellerid")?!0:!1}function o(e){return e=parseFloat(e)/100,e>9999.99?e.toFixed(0):e.toFixed(2)}var s=(e.DOM,e.Event,{getCurrentCity:function(){return e.DOM.attr("#J_JuNav","data-ck")},getJuApiData:function(){var t=e.one(".J_PointRecommend");if(t){var i=(a()?"//img02.taobaocdn.net/bao/uploaded/":"//gju4.alicdn.com/bao/uploaded/",a()?"//ju.daily.taobao.net/tg/home.htm":"//ju.taobao.com/tg/home.htm",this),n='<h4>同店限时特惠</h4>                <div class="slidecont J_Slide">                    <ul class="item-list-v2 item-list-{{type}}">                        {{#each list}}                        <li class="pannelcls">                            <div class="item-status {{isNotBegin baseinfo.ostime}} {{isSoldOut baseinfo.oetime baseinfo.ostime isLock}}">                                <a target="_blank" href="{{baseinfo.itemUrl}}" title="{{name.longName}}" class="link-box" >                                    <div class="item-pic-wrap">                                        <img class="item-pic" src="{{baseinfo.picUrl}}_336x336Q90.jpg">                                    </div>                                    <i class="soldout-mask"></i>                                    {{#if type!=="small"}}</a>{{/if}}                                    <div class="titarea">                                        <h2>                                        {{#if merit&&merit.up&&merit.up.length}}                                        {{#each merit.up}}{{this}} {{/each}}                                        {{/if}}                                        </h2>                                        <h3 title="{{name.longName}}">{{name.shortName}}</h3>                                    </div>                                    <div class="item-prices">                                        <span class="price">                                            {{#if price.pointTag&&price.pointTag==="tmallPoint"}}                                                {{#if this.tag!=="by"}}                                                    <i>&yen;</i>{{price.actPrice}}                                                {{/if}}                                            {{else}}                                                <em>{{price.actPrice}}</em>                                            {{/if}}                                        </span>                                        {{#if price.pointTag&&price.pointTag==="tmallPoint"}}                                            <i class="tm-icon"></i>                                        {{/if}}                                        <div class="dock">                                            {{#each name.tags}}                                            {{#if this.tag!=="by"}}                                                <span class="benefit icon-{{this.tag}}">{{this.text}}</span>                                            {{/if}}                                            {{/each}}                                            <del class="orig-price">&yen;{{price.origPrice}}</del>                                        </div>                                        {{#if remind}}                                            {{#if baseinfo.itemStatus==="blank"}}                                                {{#if remind.remindNum>0}}                                                <span class="sold-num">{{remind.remindNum}}人想买</span>                                                {{/if}}                                            {{/if}}                                            {{#if baseinfo.itemStatus==="avil"}}                                                {{#if remind.soldCount>0}}                                                <span class="sold-num"><em>{{remind.soldCount}}</em>件已付款</span>                                                {{/if}}                                            {{/if}}                                            {{#if baseinfo.itemStatus==="timeout"||baseinfo.itemStatus==="soldout"}}                                                {{#if remind.soldCount>0}}                                                    <span class="sold-num"><em>{{remind.soldCount}}</em>件已付款</span>                                                {{else}}                                                    <span class="sold-num">抢光啦！</span>                                                {{/if}}                                            {{/if}}                                        {{/if}}                                    </div>                                {{#if type==="small"}}</a>{{/if}}                            </div>                        </li>                        {{/each}}                    </ul>                    <a class="trigger prev"><b>&#9001;</b></a>                    <a class="trigger next"><b>&#9002;</b></a>                </div>';e.use("jbc/jupicker2",function(e,a){var o=e.one("#juId")?e.one("#juId").val():0;a.getItems({sellerIds:t.attr("data-sellerid"),juid:o,size:1,psize:11},function(a){if(a&&a.length)for(var s=0;s<a.length;s++)if(a[s].baseinfo.juId==o){a.splice(s,1);break}if(a.length){11==a.length&&a.splice(10,1);var l={list:a,type:1==a.length?"big":"small"};e.use("xtemplate",function(e,a){var o={commands:{priceInt:function(e,t){return parseInt(t.params[0]/100)},priceDecimal:function(e,t){return(t.params[0]/100).toFixed(1).split(".")[1]},isNotBegin:function(e,t){return t.params[0]>(new Date).getTime()?"not-begin":""},isSoldOut:function(e,t){return t.params[0]<(new Date).getTime()||t.params[1]<(new Date).getTime()&&0===t.params[2]?"sold-out":""}}},s=new a(n,o).render(l);t.html(s).show(),t.all(".sold-out").each(function(t,i){e.one(".item-list-v2").append(e.one(t).parent())}),e.one(".sub-box")&&e.one(".sub-box").show();var c=e.one(".J_Slide");c&&i.renderQuanSlide(c,{effect:"hSlide",colspan:2,autoSlide:!1,timeout:4e3,contentClass:"item-list-v2",pannelClass:"pannelcls"})})}})})}},renderQuanSlide:function(t,i){e.use("gallery/slide/1.2/",function(e,a){var n=t.all("li").length;if(2>=n)return void t.all(".trigger").remove();var o=new a(t,i),s=1,l=0,c=2;t.one(".next").on("click",function(){s>=n-1?(o.go(0),s=1,l=0):s+c>n-1?(o.go(n-1),s=n-1,l=s-1):(o.go(s+1),s+=c,l=s-1)}),t.one(".prev").on("click",function(){0>=l?(o.go(n-1),s=n-1,l=s-1):0>=l-c?(o.go(0),l=0,s=1):(o.go(l-c),l-=c,s=l+1)})})},getDetailData:function(t){var a=e.one(".J_RightRecommend");if(a){var n="//athena.ju.taobao.com/api/recommend.htm",o=this,s=e.one("#itemId");s&&t&&e.io({type:"get",url:n,data:{app:"item_detail",cid:s.val(),c:"i",ft:"jsonp",count:6},success:function(e,t){if(e=o.formatSoldoutRecommData(e),e&&e.list&&e.list.length){var n=e.list.length;n&&a.show(),o.renderCommendData(e,a)}e.listDesc.trackParams&&(e.listDesc.trackParams.spmid=a.attr("data-spm"),i.exposure(e.listDesc.trackParams,"jhs.3.6.1"))},dataType:"jsonp",jsonp:"callback"})}},renderCommendData:function(t,i){e.use("template",function(e,a){var n=e.Template(['<div class="tab-content">',"<ul>","{{#each list as item index}}",'<li class="tab-pannel">','<a target="_blank" href="{{item.jhsItemUrl}}">','<img src="{{item.fullPicUrl}}" alt="{{item.longName}}" title="{{item.longName}}" />','<div class="look-price">',"<span>&yen;{{item.activityPrice}}</span>","<h5>{{item.shortName}}</h5>","</div>","</a>","</li>","{{/each}}","</ul>","</div>"].join("")),o=i.one(".J_RememList");return o&&i?(o.html(n.render(t)),t.list.length<=3?(i.all(".trigger").remove(),void o.height(152*t.list.length)):void e.use("gallery/slide/1.2/",function(e,t){var a=new t(i,{effect:"vSlide",autoSlide:!1}),n=i.all(".tab-pannel").length,o=0,s=3,l=n-s,c=i.one(".prev"),r=i.one(".next");r.on("click",function(){o===l?(a.go(0),o=0):(o+=s,o>=l?(o=l,a.go(l)):a.go(o))}),c.on("click",function(){0===o?(a.go(l),o=l):(o-=s,0>=o?(o=0,a.go(0)):a.go(o))})})):void 0})},getSoldoutRecommData:function(){var t=this,i=e.one("#itemId");if(i){var a="//athena.ju.taobao.com/api/recommend.htm";e.io({type:"get",url:a,data:{app:"item_sold_out",c:"i",ft:"jsonp",cid:i.val(),count:8},success:function(e){e=t.formatSoldoutRecommData(e),e.title="此宝贝卖光了，现不支持购买，看看其他宝贝",e&&e.list&&e.list.length&&(e.list=e.list.slice(0,8),t.renderSoldoutRecommData(e))},error:function(e){},dataType:"jsonp",jsonp:"callback"})}},formatSoldoutRecommData:function(e){for(var t,i=e.list,a="_200x200.jpg",n=0,s=i.length;s>n;n++)t=i[n],t.activityPrice=o(t.activityPrice),t.fullPicUrl+=a;return e},renderSoldoutRecommData:function(t){e.use("template",function(e,a){var n=e.Template(['<div class="floatrecombg J_floatRec" data-spm="soldout-rec">','<a href="#" class="closebtn J_SoldoutRecCloseBtn">&#xe63f;</a>','<div class="ju-wrapper">',"<h2>{{title}}</h2>",'<div class="floatrecom J_SoldoutRecomm">','<div class="tab-content">',"{{#each list as item index}}",'<div class="tab-pannel">','<a target="_blank" href="{{item.jhsItemUrl}}">','<img src="{{item.fullPicUrl}}" alt="{{item.longName}}" title="{{item.longName}}" />','<div class="wrap">','<span class="title">{{item.shortName}}</span>','<span class="price">&yen;<em>{{item.activityPrice}}</em></span>','<span class="soldnum">',"{{#if item.soldCount===0}}{{#else}}<em>{{item.soldCount}}</em>件已付款{{/if}}","</span>","</div>","</a>","</div>","{{/each}}","</div>",'<a href="javascript:void(0);" class="trigger prev {{#if list.length<5}}disabled{{/if}}">&#xe63e;</a>','<a href="javascript:void(0);" class="trigger next {{#if list.length<5}}disabled{{/if}}">&#xe615;</a>',"</div>","</div>","</div>"].join("")),o=e.one(n.render(t));e.one("body").append(o),o.addClass("show");var s=e.one(".J_floatRec");t.listDesc.trackParams&&s&&(t.listDesc.trackParams.spmid=s.attr("data-spm"),i.exposure(t.listDesc.trackParams,"jhs.3.6.1")),e.one(".J_SoldoutRecCloseBtn").on("click",function(t){t.halt(),e.one(".J_SoldoutRecCloseBtn").parent().remove()}),t.list.length<=4||e.use("gallery/slide/1.2/",function(e,t){var i=e.one(".J_SoldoutRecomm"),a=new t(i,{effect:"hSlide",autoSlide:!1,colspan:4}),n=i.all(".tab-pannel").length,o=0,s=4,l=n-s,c=i.one(".prev"),r=i.one(".next");r.on("click",function(){o===l?(a.go(0),o=0):(o+=s,o>=l?(o=l,a.go(l)):a.go(o))}),c.on("click",function(){0===o?(a.go(l),o=l):(o-=s,0>=o?(o=0,a.go(0)):a.go(o))})})})},init:function(i){var a=this;if(n())a.getJuApiData();else{var o=e.one("#J_HasSoldoutRecomm");if(o&&"true"===o.val())a.getSoldoutRecommData();else{var s=-1!==location.href.indexOf("hideMore=true"),l=e.one(".J_RecommendWrap");if(l&&!s){var c=new t({container:l,autoDestroy:!1,diff:10});c.addCallback(l,function(){c.destroy(),a.getDetailData(i)})}}}}});return s},{requires:["jbc/lazyload","jbc/julog","core"]});