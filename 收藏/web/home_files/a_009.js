KISSY.add("my/mods/detaileval",function(t){var e=t.DOM,a=t.Event,n=-1!=window.location.href.indexOf("daily"),i=!1,s=null,o=null,r=null,l=t.get(".J_DetailEval"),c=l.getAttribute("data-eval-type"),p=t.all(".J_rateTypeFilter"),d=t.one("#J_showCntFilter"),m=t.one(".J_rateSort"),h=t.get(".J_EvalInf",l),u=t.get(".J_GradeAvg",l),g=t.get(".J_RateTotal",l),f=(t.get(".J_HiddenTrigger",l),t.get(".J_TabEval")),v=3,b=function(){this.extendFields={},this.getApi=function(){throw new Error("getApi(): 该接口还没有实现!")},this.normalizeData=function(){throw new Error("convert(): 该接口还没有实现!")},this.getFields=function(){throw new Error("getFields(): 该接口还没有实现")},this.packageField=function(){var e=this.getFields();return t.mix(e,this.extendFields,!0)},this.getResponse=function(e){var a=this,n=this.getApi();if(!n)throw new Error("getResponse(): 没有配置API");t.IO.jsonp(n,this.packageField(),function(n){var i=a.normalizeData(n);t.isFunction(e)&&e(i)})}};b.getSellerId=function(){return t.get(".J_DetailEval").getAttribute("data-seller-id")},b.getItemId=function(){return t.get(".J_DetailEval").getAttribute("data-item-id")};var w=function(){this.getApi=function(){return n?"//rate.daily.tmall.net/list_dsr_info.htm":this.apiStatus?"//dsr-rate.tmall.com/list_dsr_info.htm":"//rate.tmall.com/list_dsr_info.htm"},this.normalizeData=function(t){var e=t.dsr;return e.tabShow=e.rateTotal||0,e},this.getFields=function(){return{itemId:b.getItemId(),sellerId:b.getSellerId(),t:+new Date}},n||(this.apiStatus=!0)};w.prototype=new b;var y=function(){this.getApi=function(){return n?"//rate.daily.taobao.net/detailCommon.htm":"//rate.taobao.com/detailCommon.htm"},this.normalizeData=function(t){var e=t.data;return{peopleNum:e.count.total,gradeAvg:e.correspond,rateTotal:e.correspondCount,tabShow:e.count.total}},this.getFields=function(){return{userNumId:b.getSellerId(),auctionNumId:b.getItemId(),t:+new Date}}};y.prototype=new b;var I=function(){this.getApi=function(){return n?"//rate.daily.tmall.net/listTagClouds.htm":"//rate.tmall.com/listTagClouds.htm"},this.normalizeData=function(t){return t.tags.tagClouds},this.getFields=function(){return{itemId:b.getItemId(),isAll:!0,isInner:!0,t:+new Date}}};I.prototype=new b;var C=function(){this.getApi=function(){return n?"//orate.daily.alicdn.net/detailCommon.htm":"//rate.taobao.com/detailCommon.htm"},this.normalizeData=function(t){var e=t.data.impress;if(e&&e.length)for(var a=0;a<e.length;a++)e[a].tag=e[a].title,e[a].posi=1==e[a].value?!0:!1;return e},this.getFields=function(){return{userNumId:b.getSellerId(),auctionNumId:b.getItemId(),t:+new Date}}};C.prototype=new b;var P=function(){this.getApi=function(){return n?"//rate.daily.tmall.net/list_detail_rate.htm":"//rate.tmall.com/list_detail_rate.htm"},this.normalizeData=function(e){if(e.rateDetail){var a={comments:[],hasSKU:!1,page:{total:e.rateDetail.paginator.lastPage,current:e.rateDetail.paginator.page,hasPage:0!=e.rateDetail.paginator.lastPage}},n=e.rateDetail.rateList;return t.each(n,function(t){var e=[];if(t.auctionSku)for(var n=t.auctionSku.split(";"),i=0;i<n.length;i++)e.push({prop:n[i].split(":")[0],val:n[i].split(":")[1]});var s=[];if(t.userInfo)for(var o=t.userInfo.split(";"),i=0;i<o.length;i++)s.push({prop:o[i].split(":")[0],val:o[i].split(":")[1]});(e.length||s.length)&&(a.hasSKU=!0);var r=[];if(t.pics&&t.pics.length)for(var i=0;i<t.pics.length;i++)r.push({thumbnail:t.pics[i],url:t.pics[i]});if(t.appendComment.pics&&t.appendComment.pics.length){t.appendComment.photos=[];for(var i=0;i<t.appendComment.pics.length;i++)t.appendComment.photos.push({thumbnail:t.appendComment.pics[i],url:t.appendComment.pics[i]})}var l={nickName:t.displayUserNick,userLink:t.displayUserLink,date:t.rateDate,content:t.rateContent,photos:r,auctionSku:e,userInfo:s,displayRatePic:t.displayRatePic,anony:t.anony,displayUserNumId:t.displayUserNumId,tamllSweetLevel:t.tamllSweetLevel,tmallSweetPic:t.tmallSweetPic,serviceRateContent:t.serviceRateContent,appendComment:t.appendComment,reply:t.reply};a.comments.push(l)}),a}},this.getFields=function(){var t=d.attr("checked")?1:0;return{itemId:b.getItemId(),sellerId:b.getSellerId(),order:v,forShop:1,content:t}},this.getResponseByPage=function(t,e){this.extendFields.currentPage=t,this.getResponse(e)},this.setExpandFields=function(e,a){if("tagsField"==e&&(this.extendFields={},a&&(this.extendFields.posi=t.one(a).attr("data-posi"),this.extendFields.tagId=t.one(a).attr("data-id"))),"rateTypeField"==e){this.extendFields={};var n=t.one(a).val();switch(n){case"1":this.extendFields.append=1;break;case"2":this.extendFields.picture=1}}}};P.prototype=new b;var k=function(){this.getApi=function(){return n?"//rate.daily.taobao.net/feedRateList.htm":"//rate.taobao.com/feedRateList.htm"},this.normalizeData=function(e){function a(t){var e=t.maxPage,a=t.currentPageNum;return 1!=a||5!=e&&4!=e?e:2}var n={comments:[],hasSKU:!1,page:{total:a(e),current:e.currentPageNum,hasPage:0!=e.maxPage}},i=e.comments;return t.each(i,function(t){var e=[];if(t.auction&&t.auction.sku)for(var a=t.auction.sku.split("&nbsp;&nbsp"),i=0;i<a.length;i++)e.push({prop:a[i].split(":")[0],val:a[i].split(":")[1]});var s=[];if(t.spuRatting&&t.spuRatting.length)for(var o=t.spuRatting,i=0;i<o.length;i++)s.push({prop:o[i].name,val:o[i].desc});(e.length||s.length)&&(n.hasSKU=!0),t.reply&&(t.reply=t.reply.content),t.append&&(t.append.days=t.append.dayAfterConfirm,t.append.reply=t.append.reply?t.append.reply.content:"");var r={nickName:t.user.nick,userLink:t.user.nickUrl,date:t.date,content:t.content,photos:t.photos,auctionSku:e,userInfo:s,displayRatePic:t.user.displayRatePic,anony:t.user.anony,displayUserNumId:t.user.userId,tamllSweetLevel:0,tmallSweetPic:"",serviceRateContent:"",appendComment:t.append,reply:t.reply};n.comments.push(r)}),n},this.getFields=function(){var t=d.attr("checked")?1:"";return{userNumId:b.getSellerId(),auctionNumId:b.getItemId(),siteID:7,currentPageNum:1,orderType:"sort_weight",showContent:t}},this.getResponseByPage=function(t,e){this.extendFields.currentPageNum=t,this.getResponse(e)},this.setExpandFields=function(e,a){if("tagsField"==e&&(this.extendFields={},a&&(this.extendFields.attribute=t.one(a).attr("data-attribute"))),"rateTypeField"==e){this.extendFields={};var n=t.one(a).val();switch(n){case"1":this.extendFields.rateType=2;break;case"2":this.extendFields.rateType=3}}}};k.prototype=new b;var x=function(){this.getApi=function(){return n?"//ju.daily.taobao.net/json/tg/ajaxLifeReviewList.htm":"//ju.taobao.com/json/tg/ajaxLifeReviewList.htm"},this.normalizeData=function(e){var a="//ju.taobao.com/tg/home.htm";n&&(a="//ju.daily.taobao.net/tg/home.htm");var i={comments:[],page:{total:1,current:1,hasPage:!0,hideHead:!0}},s=e.reviewList;return s&&0==s.length&&(i.page.hasPage=!1,i.page.hideHead=!1),t.each(s,function(t){var e={nickName:t.userNick,userLink:a+"?item_id="+b.getItemId(),date:t.reviewTime,content:t.reviewCont};i.comments.push(e)}),i},this.getFields=function(){var e=t.all("#curCity").val()||"";return{itemId:b.getItemId(),jcity:e}},this.getResponseByPage=function(t,e){this.extendFields.currentPageNum=t,this.getResponse(e)}};x.prototype=new b;var _=function(){function n(){var e=t.one("#J_ratetagtoggle");e&&e.on("click",function(){i=!i,_.getEvalTags()});var a=t.all("#J_evalKeyword li");a.length&&a.on("click",function(e){t.one(this).hasClass("selected")?(F(),r.setExpandFields("tagsField")):(t.one(this).siblings().removeClass("selected"),t.one(this).addClass("selected"),r.setExpandFields("tagsField",this)),T(),r.getResponse(E)})}function b(){if(p&&p.on("click",function(t){F(),r.setExpandFields("rateTypeField",this),r.getResponse(E)}),d&&d.on("click",function(t){r.getResponse(E)}),m){m.on("mouseenter",function(t){m.one("ul").show()}),m.on("mouseleave",function(t){m.one("ul").hide()});var t=m.one(".tm-r-default"),e=m.one(".tm-r-time"),a=m.one(".tm-current");t&&e&&a&&(t.on("click",function(n){t.hide(),e.show(),a.text(t.text()),v=parseInt(t.attr("data-val")),r.getResponse(E)}),e.on("click",function(n){e.hide(),t.show(),a.text(e.text()),v=parseInt(e.attr("data-val")),r.getResponse(E)}))}}function S(){function n(a){var n=parseInt(t.trim(t.get(".page-cur",i).innerHTML)),s=null;return s=e.hasClass(a,"page-prev")?n-1:e.hasClass(a,"page-next")?n+1:a.innerHTML}var i=t.get(".J_EvalPage"),s=t.query("a",i);a.on(s,"click",function(t){t.preventDefault();var a=n(this);r.getResponseByPage(a,E);var i=".J_TabFixHolder",s=e.offset(i).top-e.scrollTop();e.scrollTop(window,e.scrollTop()+s+2)})}function D(){var e=t.all(".J_PhotoThumb");if(e.length){var a=!1;e.on("click",function(e){if(!a){a=!0;var n=t.one(this),i=n.parent().next(),s=n.attr("data-src");i.html("<img src='"+s+"'>");var o=i.one("img");o.on("load",function(){var t=n.hasClass("tb-current");if(t){n.removeClass("tb-current"),i.removeClass("tb-current");var e={width:0,height:0,opacity:0}}else{n.addClass("tb-current"),n.siblings().removeClass("tb-current"),i.addClass("tb-current");var e={width:i.one("img").width()+10,height:i.one("img").height()+10,opacity:1}}i.animate(e,.3,"easeNone",function(){a=!1})})}});var n=t.all(".J_PhotoView");n.length&&n.on("click",function(e){var a=t.one(this),n=a.prev().all("li");n.removeClass("tb-current");var i={width:0,height:0,opacity:0};a.animate(i,.3,"easeNone",function(){a.removeClass("tb-current")})})}}function F(){var e=t.all("#J_evalKeyword li");e.length&&e.removeClass("selected")}function T(){p.each(function(e,a){0==a?t.one(e).attr("checked",!0):t.one(e).removeAttr("checked")})}function R(){switch(c){case"1":o=new y,s=new C,r=new k;break;case"2":o=new y,s=new C,r=new k;break;case"3":o=new w,s=new I,r=new P}}function J(e){var e={tagsData:e,isTagExpand:i},a=["{{#if tagsData && tagsData.length}}",'<div class="eval-keyword"><div class="tit">大家印象：</div>','<div id="J_tagList"><ul>',"{{#each tagsData as tagItem}}","{{#if tagItem.posi==true}}",'<li class="J_true" data-posi="1" {{#if tagItem.id}}data-id="{{tagItem.id}}"{{/if}} {{#if tagItem.attribute}}data-attribute="{{tagItem.attribute}}"{{/if}}>{{tagItem.tag}} ({{tagItem.count}})<b class="eval-icon-dg"></b></li>',"{{/if}}","{{/each}}","{{#each tagsData as tagItem}}","{{#if tagItem.posi==false}}",'<li class="badly J_false" data-posi="-1" {{#if tagItem.id}}data-id="{{tagItem.id}}"{{/if}} {{#if tagItem.attribute}}data-attribute="{{tagItem.attribute}}"{{/if}}>{{tagItem.tag}} ({{tagItem.count}})<b class="eval-icon-dg"></b></li>',"{{/if}}","{{/each}}","</ul>","{{#if tagsData.length>8}}",'<div class="rate-tag-toggle {{#if isTagExpand}}rate-tag-toggle-expand{{/if}}" id="J_ratetagtoggle" title="显示所有信息"></div>',"{{/if}}","</div>","{{/if}}"],s=t.Template(a.join("")).render(e),o=t.get("#J_evalKeyword");o.innerHTML=s;var r=t.one("#J_evalKeyword").all(".J_true"),l=t.one("#J_evalKeyword").all(".J_false");!i&&l.length&&(r.each(function(e,a){a>5&&t.one(e).remove()}),t.one("#J_tagList ul").height(60)),n()}function E(e){var e=L(e),e=new _.Page(e).getData(),a=["{{#if page.hasPage}}","<table>","{{#each comments as comment}}","<tr>","<td>",'<div class="tdcnt {{#if hasSKU}}col-3{{/if}}">','<div class="cnt">',"{{#if comment.serviceRateContent}}",'<p><span class="gray">商品：</span>{{comment.content}}</p>','<p><span class="gray">服务：</span>{{comment.serviceRateContent}}</p>',"{{#else}}","<p>{{comment.content}}</p>","{{/if}}","</div>","{{#if comment.photos && comment.photos.length}}",'<div class="eval-photolist">',"<ul>","{{#each comment.photos as photo}}",'<li class="J_PhotoThumb" data-src="{{photo.url}}">','<img src="{{photo.thumbnail}}" width="40" height="40"><b class="eval-photo-allow"></b>',"</li>","{{/each}}","</ul>",'<div class="eval-photo-view J_PhotoView"></div>',"</div>","{{/if}}",'<div class="gray">{{comment.date}}</div>',"{{#if comment.reply}}",'<div class="eval-answer">',"[掌柜回复] {{comment.reply}}","</div>","{{/if}}","{{#if comment.appendComment}}",'<div class="eval-addition">',"<p>",'<span class="gray">[追加评论] </span>',"{{comment.appendComment.content}}","</p>",'<p class="gray">确认收货后{{#if comment.appendComment.days==0}}当{{#else}}{{comment.appendComment.days}}{{/if}}天追加</p>',"</div>","{{#if comment.appendComment && comment.appendComment.photos && comment.appendComment.photos.length}}",'<div class="eval-photolist">',"<ul>","{{#each comment.appendComment.photos as photo}}",'<li class="J_PhotoThumb" data-src="{{photo.url}}">','<img src="{{photo.thumbnail}}" width="40" height="40"><b class="eval-photo-allow"></b>',"</li>","{{/each}}","</ul>",'<div class="eval-photo-view J_PhotoView"></div>',"</div>","{{/if}}","{{#if comment.appendComment && comment.appendComment.reply}}",'<div class="eval-answer">',"[掌柜回复] {{comment.appendComment.reply}}","</div>","{{/if}}","{{/if}}","</div>","</td>","{{#if hasSKU}}","<td>",'<div class="sku">',"{{#if comment.auctionSku && comment.auctionSku.length}}","{{#each comment.auctionSku as sku}}",'<p>{{sku.prop}}：<span class="gray">{{sku.val}}</span></p>',"{{/each}}",'<div class="space-x"></div>',"{{/if}}","{{#if comment.userInfo && comment.userInfo.length}}","{{#each comment.userInfo as userInfo}}",'<p>{{userInfo.prop}}：<span class="gray">{{userInfo.val}}</span></p>',"{{/each}}","{{/if}}","</div>","</td>","{{/if}}","<td>",'<div class="customer">','<div class="rate-user-info">',"{{#if !comment.anony}}",'<a href="{{comment.userLink}}" target="_blank">{{comment.nickName}}</a>',"{{#else}}","{{comment.nickName}}<span>（匿名）</span>","{{/if}}","</div>",'<div class="rate-user-grade">',"{{#if comment.tamllSweetLevel && comment.tamllSweetLevel!==0}}",'<a href="//vip.tmall.com" target="_blank" title="天猫T{{comment.tamllSweetLevel}}达人">','<img src="//g.alicdn.com/tm/member-club/4.6.0/img/{{comment.tmallSweetPic}}">',"</a> ","{{/if}}","{{#if comment.displayRatePic}}","{{#if !comment.anony}}",'<a target="_blank" href="//rate.taobao.com/rate.htm?user_id={{comment.displayUserNumId}}&rater=1">','<img src="//assets.alicdn.com/sys/common/icon/rank_s/{{comment.displayRatePic}}">',"</a>","{{#else}}",'<img src="//assets.alicdn.com/sys/common/icon/rank_s/{{comment.displayRatePic}}">',"{{/if}}","{{/if}}","</div>","</div>","</td>","</tr>","{{/each}}","</table>","{{#else}}","<table>","<tr><td>",'<div class="eval-inf">','<p class="eval-txt">没有找到相关结果</p>',"</div>","</td></tr>","</table>","{{/if}}","{{#if page.hasPage && !page.hideHead}}",'<div class="ju-pagination J_EvalPage" style="overflow:hidden">','<div class="page-bottom bt">',"{{#each buttons as button}}","{{#if button.isPrev}}","{{#if button.isDisable}}",'<span class="page-start"><span><b class="icon"></b>上一页</span></span>',"{{#else}}",'<a class="page-prev" href="#"><b class="icon"></b>上一页</a>',"{{/if}}","{{#elseif button.isNext}}","{{#if button.isDisable}}",'<span class="page-end"><b class="icon"></b>下一页</span>',"{{#else}}",'<a class="page-next" href="#">下一页<b class="icon"></b></a>',"{{/if}}","{{#elseif button.isBreak}}",'<span class="page-break">...</span>',"{{#elseif button.isCurrent}}",'<span class="page-cur">{{button.index}}</span>',"{{#else}}",'<a href="javascript:void(0)">{{button.index}}</a>',"{{/if}}","{{/each}}","</div>","</div>","{{/if}}"],n=t.Template(a.join("")).render(e);h.innerHTML=n,e.page&&e.page.hideHead&&(t.all(".J_EvalFilter").hide(),t.all(".eval-hd").hide(),t.all(".J_EvalPage").hide()),S(),D()}function N(e){return o.apiStatus&&5===parseInt(e.gradeAvg)&&0===parseInt(e.rateTotal)?(o.apiStatus=!1,void o.getResponse(N)):(t.get("strong",f).innerHTML=e.tabShow?e.tabShow:0,t.get("em",u).innerHTML=Number(e.gradeAvg).toFixed(2).slice(0,-1),t.get("em",g).innerHTML=e.rateTotal,void(0==+e.tabShow&&JU_DETAIL_DYNAMIC&&"false"==JU_DETAIL_DYNAMIC.isEnableLifeReview&&(t.all("strong",f).hide(),r=new x)))}function L(t){if(t){for(var e=t.comments.length;e--;)t.comments[e].content=t.comments[e].content.replace(/\\n|\\r|\\t|\\f/g,""),t.comments[e].reply&&(t.comments[e].reply=t.comments[e].reply.replace(/\\n|\\r|\\t|\\f/g,"")),t.comments[e].appendComment&&(t.comments[e].appendComment.content&&(t.comments[e].appendComment.content=t.comments[e].appendComment.content.replace(/\\n|\\r|\\t|\\f/g,"")),t.comments[e].appendComment.reply&&(t.comments[e].appendComment.reply=t.comments[e].appendComment.reply.replace(/\\n|\\r|\\t|\\f/g,"")));return t}}function A(){l&&(R(),b())}function B(){s.getResponse(J)}function M(){o.getResponse(N)}function H(){r.getResponse(E)}return{init:A,getEvalTags:B,getEvalRate:M,getEvalInfo:H}}();return _.Page=function(t){this.total=null,this.current=null,this.buttons=[],this.init(t),this.calculatePage(),this.generatePage()},_.Page.DefaultConfig={prevPage:2,pageShow:7,pageGap:7,pageMax:7,currentPos:3},_.Page.prototype.getData=function(){return this.data},_.Page.prototype.calculatePage=function(){this.isDisablePrev=1==this.current,this.isDisableNext=this.current==this.total,this.isShowBreakHead=this.current>=this.pageGap,this.isShowBreakEnd=this.total>=this.pageMax&&this.current<this.total,this.isShowBreakHead&&(this.pageMax+=1),this.isShowBreakEnd&&(this.pageMax+=1),this.current==this.total&&this.currentPos++,this.current<this.total&&(this.CisShowBreakEnd=!0)},_.Page.prototype.generateButton=function(t,e){var a=new _.Page.Button,n=t+1;if(e)if(n==this.pageMax&&this.isShowBreakEnd)a.isBreak=!0;else if(n<=this.prevPage||!this.isShowBreakHead&&n>this.prevPage)a.index=n;else if(n==this.prevPage+1&&this.isShowBreakHead)a.isBreak=!0;else{var i=n-(this.prevPage+2);a.index=this.current-this.currentPos+i}else n==this.total+1?a.isBreak=!0:a.index=n;return a.index==this.current&&(a.isCurrent=!0),a},_.Page.prototype.generatePage=function(){var t=_.Page.Button,e=this.total>this.pageMax,a=Math.min(this.pageMax,this.total);this.CisShowBreakEnd&&!e&&a++;var n=new t;n.isPrev=!0,n.isDisable=this.isDisablePrev;var i=new t;i.isNext=!0,i.isDisable=this.isDisableNext,this.buttons.push(n);for(var s=0;a>s;s++)this.buttons.push(this.generateButton(s,e));this.buttons.push(i),this.data.buttons=this.buttons},_.Page.prototype.init=function(e){this.data=e,this.total=this.data.page.total,this.current=this.data.page.current,t.mix(this,_.Page.DefaultConfig)},_.Page.Button=function(){this.isPrev=!1,this.isNext=!1,this.isBreak=!1,this.isCurrent=!1,this.isDisable=!1,this.index=1},_.init(),{showTags:function(){_.getEvalTags()},showNum:function(){_.getEvalRate()},showList:function(){_.getEvalInfo()}}},{requires:["core"]});