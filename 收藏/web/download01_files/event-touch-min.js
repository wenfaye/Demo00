define("event-touch",["util","dom","event-dom-base","feature"],function(e){var t,n,o,r,i,a,u,s,c,h=e("util"),d=e("dom"),l=e("event-dom-base"),v=e("feature");return t=function(e){function t(e){return m.startsWith(e,"touch")}function n(e){return m.startsWith(e,"mouse")}function o(e){return m.startsWith(e,"MSPointer")||m.startsWith(e,"pointer")}function r(e){var t=this;t.doc=e,t.eventHandles=[],t.init(),t.touches=[],t.inTouch=0}function i(e){c(this,e)}function a(e){p(this,e)}function u(e){i.call(this,e),S[e].setup.apply(this,arguments)}function s(e){a.call(this,e),S[e].tearDown.apply(this,arguments)}function c(e,t){var n=E.getDocument(e),o=E.data(n,w);o||E.data(n,w,o=new r(n)),t&&o.addEventHandle(t)}function p(e,t){var n=E.getDocument(e),o=E.data(n,w);o&&(t&&o.removeEventHandle(t),o.eventHandles.length||(o.destroy(),E.removeData(n,w)))}var f,T,g,m=h,E=d,S={},y=l,H=y.Special,w=m.guid("touch-handle"),M=v,P=/iPad|iPhone|iPod/.test(navigator.userAgent),X=2500,Y=25;return M.isTouchEventSupported()?P?(g="touchend touchcancel",f="touchstart",T="touchmove"):(g="touchend touchcancel mouseup",f="touchstart mousedown",T="touchmove mousemove"):M.isPointerSupported()?(f="pointerdown",T="pointermove",g="pointerup pointercancel"):M.isMsPointerSupported()?(f="MSPointerDown",T="MSPointerMove",g="MSPointerUp MSPointerCancel"):(f="mousedown",T="mousemove",g="mouseup"),r.prototype={constructor:r,lastTouches:[],firstTouch:null,init:function(){var e=this,t=e.doc;y.on(t,f,e.onTouchStart,e),o(T)||y.on(t,T,e.onTouchMove,e),y.on(t,g,e.onTouchEnd,e)},addTouch:function(e){e.identifier=e.pointerId,this.touches.push(e)},removeTouch:function(e){for(var t,n=0,o=e.pointerId,r=this.touches,i=r.length;i>n;n++)if(t=r[n],t.pointerId===o){r.splice(n,1);break}},updateTouch:function(e){for(var t,n=0,o=e.pointerId,r=this.touches,i=r.length;i>n;n++)t=r[n],t.pointerId===o&&(r[n]=e)},isPrimaryTouch:function(e){return this.firstTouch===e.identifier},setPrimaryTouch:function(e){null===this.firstTouch&&(this.firstTouch=e.identifier)},removePrimaryTouch:function(e){this.isPrimaryTouch(e)&&(this.firstTouch=null)},dupMouse:function(e){var t=this.lastTouches,n=e.changedTouches[0];if(this.isPrimaryTouch(n)){var o={x:n.clientX,y:n.clientY};t.push(o),setTimeout(function(){var e=t.indexOf(o);e>-1&&t.splice(e,1)},X)}},isEventSimulatedFromTouch:function(e){for(var t,n=this.lastTouches,o=e.clientX,r=e.clientY,i=0,a=n.length;a>i&&(t=n[i]);i++){var u=Math.abs(o-t.x),s=Math.abs(r-t.y);if(Y>=u&&Y>=s)return!0}return 0},normalize:function(e){var r,i,a,u=e.type;return(i=t(u))?(a="touchend"===u||"touchcancel"===u?e.changedTouches:e.touches,e.gestureType="touch"):(o(u)?e.gestureType=e.originalEvent.pointerType:n(u)&&(e.gestureType="mouse"),a=this.touches),a&&1===a.length&&(e.which=1,e.pageX=a[0].pageX,e.pageY=a[0].pageY),i?e:(r=!u.match(/(up|cancel)$/i),e.touches=r?a:[],e.targetTouches=r?a:[],e.changedTouches=a,e)},onTouchStart:function(e){var r,i,a=this,u=e.type,s=a.eventHandles;if(t(u))a.setPrimaryTouch(e.changedTouches[0]),a.dupMouse(e);else if(n(u)){if(a.isEventSimulatedFromTouch(e))return;a.touches=[e]}else{if(!o(u))throw new Error("unrecognized touch event: "+e.type);a.addTouch(e.originalEvent),1===a.touches.length&&y.on(a.doc,T,a.onTouchMove,a)}for(var c=0,h=s.length;h>c;c++)r=s[c],i=s[r].handle,i.isActive=1;a.callEventHandle("onTouchStart",e)},onTouchMove:function(e){var r=this,i=e.type;if(n(i)){if(r.isEventSimulatedFromTouch(i))return;r.touches=[e]}else if(o(i))r.updateTouch(e.originalEvent);else if(!t(i))throw new Error("unrecognized touch event: "+e.type);r.callEventHandle("onTouchMove",e)},onTouchEnd:function(e){var r=this,i=e.type;n(i)&&r.isEventSimulatedFromTouch(e)||(r.callEventHandle("onTouchEnd",e),t(i)?(r.dupMouse(e),m.makeArray(e.changedTouches).forEach(function(e){r.removePrimaryTouch(e)})):n(i)?r.touches=[]:o(i)&&(r.removeTouch(e.originalEvent),r.touches.length||y.detach(r.doc,T,r.onTouchMove,r)))},callEventHandle:function(e,t){var n,o,r=this,i=r.eventHandles,a=i.concat();t=r.normalize(t);var u=t.gestureType;if(t.changedTouches.length){for(var s=0,c=a.length;c>s;s++)if(n=a[s],i[n]){if(o=i[n].handle,o.requiredGestureType&&u!==o.requiredGestureType)continue;if(o.processed)continue;o.processed=1,o.isActive&&o[e]&&o[e](t)===!1&&(o.isActive=0)}for(s=0,c=a.length;c>s;s++)n=i[s],i[n]&&(o=i[n].handle,o.processed=0)}},addEventHandle:function(e){var t=this,n=t.eventHandles,o=S[e].handle;n[e]?n[e].count++:(n.push(e),t.sortEventHandles(),n[e]={count:1,handle:o})},sortEventHandles:function(){this.eventHandles.sort(function(e,t){var n=S[e],o=S[t];return n.order-o.order})},removeEventHandle:function(e){var t=this.eventHandles;t[e]&&(t[e].count--,t[e].count||(t.splice(m.indexOf(e,t),1),delete t[e]))},destroy:function(){var e=this,t=e.doc;y.detach(t,f,e.onTouchStart,e),y.detach(t,T,e.onTouchMove,e),y.detach(t,g,e.onTouchEnd,e)}},e=function(e,t){"string"==typeof e&&(e=[e]),m.each(e,function(e){var n={};n.setup=t.setup?u:i,n.tearDown=t.tearDown?s:a,n.add=t.add,n.remove=t.remove,t.order=t.order||100,S[e]=t,H[e]=n})}}(),n=function(e){function t(){}var n=function(){};return t.prototype={constructor:t,requiredTouchCount:0,onTouchStart:function(e){var t=this,n=t.requiredTouchCount,o=e.touches,r=o.length;return r===n?(t.isTracking||(t.isTracking=!0,t.isStarted=!1),t.lastTouches=e.touches,t.startTime=e.timeStamp,t.start(e)):(r>n&&t.onTouchEnd(e,!0),void 0)},onTouchMove:function(e){var t=this;return t.isTracking?(t.lastTouches=e.touches,t.move(e)):void 0},onTouchEnd:function(e,t){var n=this;n.isTracking&&(n.isTracking=!1,n.isStarted&&(n.isStarted=!1,n.end(e,t)))},start:n,move:n,end:n},e=t}(),o=function(e){function t(){}var o=n,r=h;return r.extend(t,o,{requiredTouchCount:1,start:function(){t.superclass.start.apply(this,arguments);var e=this,n=e.lastTouches;e.lastXY={pageX:n[0].pageX,pageY:n[0].pageY}}}),e=t}(),r=function(e){function t(){}var o=d,r=n,i=h;return i.extend(t,r,{requiredTouchCount:2,getCommonTarget:function(e){var t=e.touches,n=t[0].target,r=t[1].target;if(n===r)return n;if(o.contains(n,r))return n;for(;r;){if(o.contains(r,n))return r;r=r.parentNode}return void 0}}),e=t}(),i=function(e){var i=t;return e={addEvent:i,Touch:n,SingleTouch:o,DoubleTouch:r}}(),a=function(e){function t(e,t,n){var o,r,i=e.lastTouches,a=i[0],u=a.pageX,s=a.pageY,h=u-e.startX,d=s-e.startY,l=Math.abs(h),v=Math.abs(d),m=t.timeStamp;if(e.isStarted=1,m-e.startTime>f)return!1;if(e.isVertical&&l>T&&(e.isVertical=0),e.isHorizontal&&v>T&&(e.isHorizontal=0),e.isVertical&&e.isHorizontal&&(v>l?e.isHorizontal=0:e.isVertical=0),n||(e.isVertical&&g>v&&(e.isVertical=0),e.isHorizontal&&g>l&&(e.isHorizontal=0)),e.isHorizontal)r=0>h?"left":"right",o=l;else{if(!e.isVertical)return!1;r=0>d?"up":"down",o=v}if(n){var E=t.originalEvent._ksSwipePrevent;return E&&(E===!0||E[r])&&t.preventDefault(),void 0}c.fire(a.target,p,{originalEvent:t.originalEvent,pageX:a.pageX,pageY:a.pageY,which:1,direction:r,distance:o,duration:(t.timeStamp-e.startTime)/1e3})}function n(){}function o(e,t,n){for(var o=!1;e!==t&&!(o=a.test(e,n));)e=e.parentNode;return o}var r=h,a=d,u=i,s=u.addEvent,c=l,v=u.SingleTouch,p="swipe",f=1e3,T=35,g=50;return r.extend(n,v,{requiredGestureType:"touch",start:function(){var e=this;n.superclass.start.apply(e,arguments);var t=e.lastTouches[0];e.isHorizontal=1,e.isVertical=1,e.startX=t.pageX,e.startY=t.pageY},move:function(e){return n.superclass.move.apply(this,arguments),t(this,e,1)},end:function(e){return n.superclass.end.apply(this,arguments),t(this,e,0)}}),s([p],{handle:new n,add:function(e){var t=e.config,n=t.preventDefault;if(n){var r=t.filter;e._preventFn=function(e){(!r||o(e.target,e.currentTarget,r))&&(e._ksSwipePrevent=n)},this.addEventListener("touchmove",e._preventFn)}},remove:function(e){e._preventFn&&(this.removeEventListener("touchmove",e._preventFn),e._preventFn=null)}}),e={SWIPE:p}}(),u=function(e){function t(e){e.preventDefault()}function n(e){e.singleTapTimer&&(clearTimeout(e.singleTapTimer),e.singleTapTimer=0),e.tapHoldTimer&&(clearTimeout(e.tapHoldTimer),e.tapHoldTimer=0)}function o(){o.superclass.constructor.apply(this,arguments)}var r=i,a=r.addEvent,u=l,s=r.SingleTouch,c=h,d="singleTap",v="doubleTap",p="hold",f="tap",T=1e3,g=300,m=5,E=u.Object,S=/iPad|iPhone|iPod/.test(navigator.userAgent);return c.extend(o,s,{start:function(e){var t=this;o.superclass.start.call(t,e),n(t);var r=t.lastTouches[0];return t.tapHoldTimer=setTimeout(function(){var n=c.mix({which:1,duration:(c.now()-e.timeStamp)/1e3},t.lastXY);t.tapHoldTimer=0,t.lastXY=0,u.fire(r.target,p,n)},T),t.isStarted=!0,void 0},move:function(){var e,t=this;if(!(e=t.lastXY))return!1;var o=t.lastTouches[0];return!o||Math.abs(o.pageX-e.pageX)>m||Math.abs(o.pageY-e.pageY)>m?(n(t),!1):void 0},end:function(e,o){var r,i=this;if(n(i),!o&&(r=i.lastXY)){var a=i.lastTouches[0],s=a.target,h=new E(e.originalEvent);c.mix(h,{type:f,which:1,pageX:r.pageX,pageY:r.pageY,target:s,currentTarget:s}),u.fire(s,f,h),h.isDefaultPrevented()&&(S?e.preventDefault():u.on(s.ownerDocument||s,"click",{fn:t,once:1}));var l,p=i.lastEndTime,T=e.timeStamp;if(i.lastEndTime=T,p&&(l=T-p,g>l))return i.lastEndTime=0,u.fire(s,v,{pageX:r.pageX,pageY:r.pageY,which:1,duration:l/1e3}),void 0;l=T-i.startTime,l>g?u.fire(s,d,{pageX:r.pageX,pageY:r.pageY,which:1,duration:l/1e3}):i.singleTapTimer=setTimeout(function(){u.fire(s,d,{pageX:r.pageX,pageY:r.pageY,which:1,duration:(c.now()-i.startTime)/1e3})},g)}}}),a([f,v,d,p],{handle:new o}),e={TAP:f,SINGLE_TAP:d,DOUBLE_TAP:v,HOLD:p}}(),s=function(e){function t(e,t){var o={isActive:1};o[t]=function(t){n.fire(t.target,e,t)},r(e,{order:1,handle:o})}var n=l,o=i,r=o.addEvent,a=e={START:"ksGestureStart",MOVE:"ksGestureMove",END:"ksGestureEnd"};return t(a.START,"onTouchStart"),t(a.MOVE,"onTouchMove"),t(a.END,"onTouchEnd"),e}(),c=function(e){var t=h,n=l,o=s,r=a,c=u,d=i,v={BasicGestureEvent:o,SwipeGestureEvent:r,TapGestureEvent:c};return v._gestureUtil=d,t.mix(n,v),e=v}()});