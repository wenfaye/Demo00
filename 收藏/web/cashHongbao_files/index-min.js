/*! mini-cart 2015-11-19 09:54:27 */
KISSY.add("tb/mini-cart",function(a,b){var c=TB.Global,d="#J_MiniCart",e="hover",f="menu-bd",g="mini-cart-";"2.0"===c.version&&(d="#J_GHeadCart",e="g_head-menu-hover",f="g_head-menu-bd",g="mini-cart-");var h=window,i=document,j=!"0"[0],k=j&&!window.XMLHttpRequest,l=i.domain,m=!(l.indexOf("taobao.com")>-1||l.indexOf("tmall.com")>-1),n=m?".daily.taobao.net":".taobao.com",o="//cart"+n+"/",p=o+"trail_mini_cart.htm?",q=o+"del_mini_cart.htm?",r="\u6b63\u5728\u5220\u9664\u4e2d",s="\u5220\u9664",t=g,u=t+"bd",v=t+"img",w=t+"count",x=t+"del",y=t+"title",z=t+"info",A=t+"ft",B=t+"price h",C=t+"ready",D="data-cartId",E=".",F="",G=function(a){var b=a.match(/&#[0-9]{1,5};/g);if(null!=b){var c,d,e;for(e=0;e<b.length;e++)c=b[e],d=c.substring(2,c.length-1),a=d>=-32768&&65535>=d?a.replace(c,String.fromCharCode(d)):a.replace(c,"")}return a.replace("<","&lt;").replace(">","&gt;")},H=function(a){if(a.css({"white-space":"nowrap",overflow:"hidden"}),"textOverflow"in i.documentElement.style||"OTextOverflow"in i.documentElement.style)a.css({"text-overflow":"ellipsis","-o-text-overflow":"ellipsis"});else{a.data("text")||a.data("text",a.text());var c=a.attr("text")||a.text(),d=a.width(),e=0,f=c.length,g=f,h=new b(a[0].cloneNode(!0)).insertAfter(a);if(a.text(c),h.text(c).css({position:"absolute",width:"auto",visibility:"hidden",overflow:"hidden"}),h.width()>d){for(;(g=Math.floor((f+e)/2))>e;)h.text(c.substr(0,g)+"\u2026"),h.width()>d?f=g:e=g;a.text(c.substr(0,g)+"\u2026"),a.attr("title")||a.attr("title",c)}h.remove()}},I=function(a){},J="\u60a8\u8d2d\u7269\u8f66\u91cc\u8fd8\u6ca1\u6709\u4efb\u4f55\u5b9d\u8d1d\u3002",K="\u7cfb\u7edf\u76ee\u524d\u7e41\u5fd9\uff0c\u8bf7\u7a0d\u540e\u518d\u8bd5\u3002",L="\u60a8\u8d2d\u7269\u8f66\u91cc\u7684\u5b9d\u8d1d\u5747\u5df2\u5931\u6548\u3002";h.MiniCart={init:function(a,b,c){var d=this;a=parseInt(a),isNaN(a)||0>a||(d.cartNum=a,b&&(c&&c(b),d._rendUI(),d.render()))},reset:function(){this._data=null,this._isRequesting=!1,this.isExpired=!0,this._rendUI()},_rendUI:function(){var a=this;a.trigger=b.one("#J_MiniCart"),a.elem=b.one("#mc-menu-hd"),a.content=a.trigger.one(".menu-bd-panel"),a._bindUI()},_bindUI:function(){var c=this,d=c.content;d.on("click",function(c){if(!TB.Global._OFF){var d,e=new b(c.target);if("a"===e[0].tagName.toLowerCase()&&(d=e.parent(),d.hasClass(x))){if(c.preventDefault(),c.halt(),e.html()===r)return;I("delete"),e.html(r),a.getScript(q+"callback=MiniCart.remove&del_id="+d.parent().attr(D)+"&t="+a.now(),function(){e.html(s),this.parentNode.removeChild(this)})}}})},remove:function(c){var d=this;if(c)if(c.status){var e=d.content,f=e.one(E+u);a.each(f.children(),function(a){if(a=new b(a),a.attr(D)==c.delCart){var e=function(){a.remove?a.remove():a[0].parentNode.removeChild(a[0]),d.setData(c),0===d.cartNum&&d.hide()};return k?e():a.animate?a.animate("opacity: 0",1,"easeOut",e):e(),!1}})}else alert(c.errMsg)},render:function(){var b=this,c=b.content,d=function(a){b.setData({status:!1,errMsg:a})};if(b._isRequesting=!1,(!b._data||b.isExpired)&&!b._isRequesting&&c){if(c.html(F).removeClass(C),b.cartNum<1)return d(J),void c.addClass(C);b._isRequesting=!0,a.later(function(){!b._clicked&&b._isShowing()&&(a.getScript(p+"callback=MiniCart.setData&t="+a.now(),function(){c.addClass(C),this.parentNode.removeChild(this)}),b._setTimeout(function(){d(K)}))},300)}},show:function(){this.render(),this.trigger.addClass("menu-hover")},hide:function(){var b=this;a.later(function(){b.trigger.removeClass(e)},2e3)},_isShowing:function(){return"block"===this.content.css("display")},_parseItem:function(b){var c=this,d=F,e=b.item,f=e?e.length:0,g=0;return f>0&&(g=b.num-f,period=parseInt(b.period,10),d+='<div class="mini-cart-hd"><strong>\u6700\u8fd1\u52a0\u5165\u7684\u5b9d\u8d1d\uff1a</strong></div><ul class="mini-cart-bd">',a.each(e,function(a){var b="//item"+n+"/item.htm?id="+a.itemId,c=G(a.title);d+="<li "+D+'="'+a.cartId+'"><div class="'+v+'"><a target="_top" href="'+b+'"><img src="'+a.picUrl+'" alt="'+c+'" /></a></div><div class="'+w+'" style="font-family: Arial;">&yen;<strong class="'+B+'">'+a.price+'</strong></div><div class="'+y+'"><a target="_top" href="'+b+'" title="'+c+'">'+c+'</a></div><div class="'+x+'"><a href="#">\u5220\u9664</a></div>'+(a.sku&&a.sku.length?'<div class="'+z+'"><span>'+a.sku.join("</span><span>")+"</span></div>":F)+(a.prefence?'<span class="flag-1111"></span>':"")+"</li>"}),d+="</ul>"),g>0&&(d+='<div class="'+A+'"><p><strong>'+c._parseRest(g,b.num)+"</strong></p></div>"),d},_parseRest:function(a){return a>0&&45>a?"\u8d2d\u7269\u8f66\u91cc\u8fd8\u6709"+a+"\u4ef6\u5b9d\u8d1d":F},_parseMsg:function(a){var b=F;return b+='<div class="'+A+'">'+(a&&a!==J?"<p>"+a+"</p>":F)+"<p>"+(a===J?a:F)+'<a target="_top" href="//cart'+n+'/my_cart.htm?from=mini&ad_id=&am_id=&cm_id=&pm_id=150042785330be233161" class="site-nav-btn">\u67e5\u770b\u6211\u7684\u8d2d\u7269\u8f66</a></p></div>'},_setTimeout:function(b){var c=this;c._timeout||(c._timeout=a.later(function(){b(),c._timeout=void 0},1e4))},_clearTimeout:function(){var a=this;a._timeout&&a._timeout.cancel(),a._timeout=void 0},off:function(){this.content.html(this._parseMsg(""))},setData:function(d){var e=this,f=F,g=e.content;if(e._clearTimeout(),d){if(d.status){var h=d.num,i=!1;if(a.isNumber(h)&&-2===h&&(h=e.cartNum-1,i=!0),TB.Global.setCartNum(h),e._data=d,h>0)if(d.item&&d.item.length)f=e._parseItem(d)+e._parseMsg(F);else if(i){var j=g.one(E+A),k=g.one(E+u).all("li").length;k?(j&&j.html(e._parseRest(h-k,h)),f=g.html()):(f=e._parseMsg(j?L:J),e.hide())}else"false"===d.isLogin?(f=e._parseMsg(""),e.hide()):(f=e._parseMsg(L),e.hide());else 0===h&&(f=e._parseMsg(J));e.isExpired=!1,setTimeout(function(){e.isExpired=!0},3e4)}else f=e._parseMsg(d.errMsg);if(-1!==d.num){g.html(f);var l=g.prev("iframe");l&&l.offset(g.offset()).width(g.width()+30).height(g.height()+20),c.use&&c.use("fn-core",function(a,b){b.iframeShim(a.util.$("J_MiniCart"),!0)}),a.each(b.all(E+y),function(a){a=new b(a);var c=280-a.prev(E+w).width()-70,d=a.one("a");d.width(c),H(d)})}}}}},{requires:["node"]});